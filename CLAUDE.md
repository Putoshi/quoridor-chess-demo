# Quoridor Chess Online プロジェクトコンテキスト

## プロジェクト概要
Quoridor Chessのオンライン対戦ゲーム。Nakama Open Sourceを使用したWebSocketリアルタイム通信による2人対戦ゲーム。

### 開発状況
- **フェーズ1（完了）**: 基盤構築、認証、マッチメイキング、チャット機能
- **フェーズ2（部分完了）**: ゲームボード実装、基本移動のみ（デモモード）
- **フェーズ3（未着手）**: 壁配置機能、真のマルチプレイヤー対戦、完全なゲームルール

## 技術スタック
- **バックエンド**: Nakama Open Source（標準イメージ使用）
- **フロントエンド**: React + TypeScript + Vite
- **通信**: WebSocket (Nakama JS Client)
- **データベース**: PostgreSQL (Nakama内蔵)
- **ゲームロジック**: クライアントサイド実装

## プロジェクト構造
```
quoridor-chess-demo/
├── .gitignore              # Git除外設定
├── README.md               # プロジェクト説明
├── CLAUDE.md               # 開発者向けコンテキスト（このファイル）
├── GAME_RULES.md           # Quoridorゲームルール詳細
├── docker-compose.yml      # Nakama + PostgreSQL構成
├── start.sh/ps1/bat        # 各OS対応起動スクリプト
├── backend/
│   ├── Dockerfile          # Goモジュールビルド用
│   ├── data/
│   │   ├── config.yml      # Nakama本番設定
│   │   └── config-minimal.yml # Nakama開発設定
│   └── modules/
│       ├── go.mod          # Go依存関係管理
│       └── main.go         # カスタムゲームロジック（296行、日本語コメント付）
└── frontend/
    ├── index.html          # HTMLエントリーポイント
    ├── package.json        # npm依存関係とスクリプト
    ├── vite.config.ts      # Viteビルド設定
    ├── tsconfig.json       # TypeScript設定
    ├── tsconfig.node.json  # Node.js用TypeScript設定
    └── src/
        ├── main.tsx        # Reactアプリエントリー（日本語コメント付）
        ├── App.tsx         # メインアプリコンポーネント（78行、日本語コメント付）
        ├── App.css         # アプリ全体のスタイル
        ├── index.css       # グローバルスタイル
        ├── components/     # Reactコンポーネント群
        │   ├── Login.tsx   # ログインフォーム（50行、日本語コメント付）
        │   ├── Login.css   # ログインスタイル
        │   ├── MatchmakingRoom.tsx # マッチメイキング（95行、日本語コメント付）
        │   ├── MatchmakingRoom.css # マッチメイキングスタイル
        │   ├── GameRoom.tsx        # ゲームルーム（1080行、日本語コメント付）
        │   ├── GameRoom.css        # ゲームルームスタイル
        │   ├── BoardComponent.tsx  # ゲームボード（187行、日本語コメント付）
        │   └── BoardComponent.css  # ボードスタイル
        └── utils/
            └── nakama.ts   # Nakamaクライアントサービス（213行、日本語コメント付）
```

## 実装済み機能

### 1. ✅ **プロジェクト基盤**
- ゲームルール定義（GAME_RULES.md）
- プロジェクト構造とビルドシステム
- Docker化された開発環境（Nakama + PostgreSQL）
- 全プラットフォーム対応起動スクリプト

### 2. ✅ **バックエンド（Nakama）**
- Nakama標準イメージによる安定したサーバー
- WebSocketベースのリアルタイム通信
- マッチ作成・参加・管理システム
- パスワードベース認証システム
- チャット機能とリアルタイムメッセージング

### 3. ✅ **フロントエンド基盤**
- React 18 + TypeScript + Vite構成
- レスポンシブUI設計
- 状態管理（useState, useEffect）
- エラーハンドリングとフォールバック

### 4. ✅ **認証・マッチメイキング**
- ユーザー名+パスワード認証
- 新規登録とログイン機能
- プライベートマッチ作成・参加
- マッチID共有システム
- リアルタイムチャット機能

### 5. ⚠️ **限定的なゲームプレイ（デモモード）**
- **9×9ゲームボード**: 視覚的なグリッドレイアウト
- **プレイヤーコマ**: 白・黒の区別、初期位置配置
- **基本移動**: 隣接マスへの1歩移動
- **ジャンプ移動**: 相手コマを飛び越える移動
- **斜めジャンプ**: ボード端での代替移動
- **ターン制システム**: 自動的なターン切り替え
- **勝利判定**: ゴールライン到達での勝利検出
- **ゲーム終了処理**: 勝利画面と再開機能

**⚠️ 重要な制限事項:**
- **壁配置機能なし** - Quoridorの核心機能が未実装
- **真のマルチプレイヤーなし** - 1人でデモプレイのみ
- **戦略性の欠如** - 壁がないため簡単すぎるゲーム

### 6. ✅ **ユーザーインターフェース**
- 直感的な日本語UI
- **視覚的移動表示**:
  - 通常移動: 青い点（•）
  - ジャンプ移動: オレンジ色の点（•）+ 黄色い点線
  - 選択中のコマ: 青いハイライト
  - 非アクティブコマ: 薄い表示
- リアルタイムゲーム状態表示
- 勝利画面とリセット機能

### 7. ✅ **開発・デバッグ支援**
- 全ファイルに詳細な日本語コメント
- コンソールでの詳細ログ出力
- 移動計算のデバッグ情報
- エラーハンドリングとフォールバック
- 包括的なドキュメント

## 未実装機能（開発ロードマップ）

### 🎯 フェーズ3: 壁配置システム（次の優先実装）
1. **壁配置UI**
   - 壁配置モードの切り替え
   - 水平・垂直壁の選択UI
   - 壁配置予定位置のプレビュー
   - 壁配置ボタンとインターフェース

2. **壁配置ロジック**
   - 壁の配置バリデーション
   - 重複チェック・残数管理
   - 経路ブロック禁止チェック（必勝防止）
   - 壁と移動の干渉判定

3. **壁の視覚表現**
   - 配置済み壁の表示
   - 壁配置可能位置のハイライト
   - 壁によるブロック状態の視覚化

### 🚀 フェーズ4: 真のマルチプレイヤー
4. **リアルタイム対戦**
   - 2人同時プレイの完全実装
   - プレイヤー間の移動・壁配置同期
   - 接続断などの対戦中トラブル対応

5. **マッチメイキング改善**
   - ランダムマッチング機能
   - 観戦モードの実装
   - 待機室での複数プレイヤー管理

### 🎨 フェーズ5: 高度な機能
6. **ゲーム体験向上**
   - アニメーション効果（移動・配置）
   - サウンドエフェクト
   - ゲーム履歴・統計
   - リプレイ機能

7. **AI・アルゴリズム**
   - 経路探索アルゴリズム（A*またはDijkstra）
   - 壁配置時の到達可能性チェック
   - 簡単なAI対戦相手
   - ゲーム分析機能

## 重要な実装詳細

### アーキテクチャ概要
**現在のアーキテクチャ:**
- **バックエンド**: Nakama標準イメージ（カスタムモジュールなし）
- **ゲームロジック**: フロントエンド（React/TypeScript）で完全実装
- **通信**: WebSocketによるリアルタイムメッセージング
- **状態管理**: クライアントサイドでゲーム状態を管理・同期

### WebSocketメッセージタイプ（OpCode別）
**OpCode 1 (システム通知):**
- `player_joined`: プレイヤー参加通知
- `player_left`: プレイヤー退出通知  
- `game_started`: ゲーム開始通知
- `start_game_request`: ゲーム開始リクエスト（未使用）

**OpCode 2 (チャット):**
- `chat`: チャットメッセージ

**OpCode 3 (ゲーム操作):**
- `move`: コマ移動データ（プレイヤーID、移動先位置）

### 主要データ構造（TypeScript）
```typescript
interface GameState {
  players: { [key: string]: Player };
  board: { size: number; walls: any[] };
  current_turn: string;
  winner: string;
  game_started: boolean;
}

interface Player {
  id: string;
  username: string;
  position: Position;
  walls: number;
  color: "white" | "black";
}

interface Position {
  x: number; // 0-8
  y: number; // 0-8
}
```

### フロントエンド状態管理

**メインアプリ状態 (App.tsx):**
- `AppState`: 'login' | 'matchmaking' | 'game' の画面遷移管理
- `username`: ログイン中のユーザー名
- `gameState`: マッチID、プレイヤー情報、作成者フラグ

**Nakamaサービス (utils/nakama.ts):**
- `nakamaService`: シングルトンサービスクラス
- **認証管理**: ユーザー名+パスワード認証
- **WebSocket接続**: リアルタイム通信の管理
- **マッチ操作**: 作成、参加、データ送信
- **エラーハンドリング**: 接続失敗時の自動フォールバック

**ゲームルーム状態 (GameRoom.tsx):**
- `gameState`: 完全なゲーム状態（プレイヤー、ボード、ターン）
- `players`: プレイヤー情報配列（UI表示用）
- `selectedPosition`: 選択中のコマ位置
- `validMoves`: 移動可能位置配列
- `jumpMoves`: ジャンプ移動位置配列
- `chatMessages`: チャット履歴

**ボードコンポーネント状態 (BoardComponent.tsx):**
- プロップスベースの純粋コンポーネント
- 移動計算とUI表示の分離
- 視覚的ハイライト管理

### 実装済みゲーム機能詳細

**移動システム:**
```typescript
// 基本移動: 隣接する空きマスへの移動
// ジャンプ移動: 相手コマを飛び越える移動
// 斜めジャンプ: ボード端での代替移動

const calculateValidMoves = (position: Position): {
  normalMoves: Position[], 
  jumpMoves: Position[] 
} => {
  // 4方向の移動を計算
  // 相手コマがいる場合はジャンプ移動を検討
  // ボード端では斜め移動を提供
}
```

**勝利判定システム:**
```typescript
const checkWinCondition = (gameState: GameState): string | null => {
  // 白プレイヤー: y=8 → y=0 で勝利
  // 黒プレイヤー: y=0 → y=8 で勝利
}
```

**ターン制御:**
- デモモード: 1人で両プレイヤーを操作
- マルチプレイヤー: 自分のターンのみ操作可能
- 自動ターン切り替え

### ゲームルール（現在実装済み部分のみ）
- **ボード**: 9×9グリッド
- **プレイヤー**: 2人（白・黒）
- **開始位置**: 白=e9(4,8), 黒=e1(4,0)  
- **基本移動**: 隣接4方向への1歩移動
- **ジャンプ移動**: 相手コマを飛び越える移動
- **勝利条件**: 相手側の端ライン到達

**❌ 未実装の重要ルール:**
- **壁配置**: 各プレイヤー10枚の壁（Quoridorの核心機能）
- **壁による移動制限**: 壁で相手の経路をブロック
- **必勝防止ルール**: 相手を完全にブロックできない制約
- **真のマルチプレイヤー**: 2人が同時に対戦する機能

## 開発時の注意事項

### 🐳 Docker環境
1. **必須サービス**: docker-compose.ymlでNakama+PostgreSQLを起動
2. **データ永続化**: PostgreSQLデータはDocker volumeで管理
3. **設定ファイル**: backend/data/config-minimal.yml を使用
4. **ログ確認**: `docker-compose logs -f nakama` でデバッグ

### 🔧 開発サーバー
1. **ポート構成**:
   - Frontend Dev Server: 3000 (Vite)
   - Nakama WebSocket: 7350
   - Nakama HTTP API: 7351
   - Nakama Console: 7351 (admin/password)
   - PostgreSQL: 5432 (内部)

2. **Go Modules**: 
   - backend/modulesで`go mod download`実行
   - Dockerビルド時に自動実行

3. **フロントエンド**:
   - `npm install`で依存関係インストール
   - Viteのホットリロード対応
   - TypeScript型チェック有効

### 🔐 認証システム
1. **Custom ID認証**: `ユーザー名:パスワード` 形式のCustom IDを使用
2. **新規登録**: `authenticateCustom(customId, true)` で新規アカウント作成
3. **ログイン**: `authenticateCustom(customId, false)` で既存アカウント認証
4. **パスワード要件**: 最小6文字以上
5. **セッション管理**: Nakamaセッションによる状態管理
6. **デバッグ用**: `nakamaService.clearSession()`でログアウト

## デバッグ・トラブルシューティング

### 🔍 ログとモニタリング
- **Nakamaコンソール**: http://localhost:7351 (admin/password)
  - マッチ一覧、プレイヤー状態、システム統計
- **Dockerログ**: `docker-compose logs -f nakama postgres`
- **ブラウザ開発者ツール**: WebSocket通信、エラー、ネットワーク
- **フロントエンドログ**: コンソールに詳細なデバッグ情報出力

### 🚨 よくある問題と解決策
1. **「No socket connection」エラー**
   - Nakamaサーバーの起動確認
   - ポート7350の接続確認
   - Docker コンテナの状態確認

2. **マッチ参加失敗**
   - マッチIDの形式確認（UUID + オプション末尾ピリオド）
   - マッチの存在確認（Nakamaコンソール）
   - 最大2人制限の確認

3. **チャットが表示されない**
   - WebSocket接続状態の確認
   - OpCode（1: システム、2: チャット）の確認
   - JSON形式エラーの確認

4. **フロントエンドビルドエラー**
   - `rm -rf node_modules package-lock.json && npm install`
   - TypeScriptエラーの確認
   - Vite設定の確認

## 次の開発ステップ（推奨順序）

### 🎯 優先度1: ゲームボード基盤
1. **BoardComponent.tsx作成**
   - 9×9グリッドの描画
   - CSS Grid/Flexboxレイアウト
   - プレイヤーコマの表示
   - 基本的なクリックイベント

2. **ゲーム状態の可視化**
   - プレイヤー位置の表示
   - 現在のターン表示
   - 残り壁数の表示

### 🎯 優先度2: 基本インタラクション
3. **コマ移動UI**
   - 移動可能マスのハイライト
   - クリック/ドラッグによる移動操作
   - 移動アニメーション

4. **サーバー連携**
   - 移動データの送信（OpCode 3）
   - サーバーでの移動バリデーション
   - 全プレイヤーへの状態同期

### 🎯 優先度3: 壁配置機能
5. **壁配置UI**
   - 壁配置モードの実装
   - 配置予定位置のプレビュー
   - 水平・垂直壁の選択

6. **壁配置ロジック**
   - サーバーでの配置バリデーション
   - 重複チェック、残数チェック
   - 経路ブロック禁止チェック（基本版）

### 🎯 優先度4: ゲーム進行
7. **ターン制実装**
   - ターン切り替えロジック
   - タイマー機能（オプション）
   - 無効操作の防止

8. **勝利判定**
   - 目標ライン到達の検出
   - ゲーム終了処理
   - 結果表示とリセット機能

### 📚 実装時の参考情報
- **Quoridorルール**: GAME_RULES.md詳細参照
- **既存コード**: 全ファイルに日本語コメント完備
- **アーキテクチャ**: WebSocket双方向通信で状態同期
- **デバッグ**: Nakamaコンソールで状態確認可能

## プロジェクト品質指標

### 📊 コード品質
- **総行数**: 約1,040行（コメント含む）
- **日本語コメント率**: 100%（全ファイル対応）
- **TypeScript導入率**: 100%（フロントエンド）
- **エラーハンドリング**: WebSocket切断、認証失敗、マッチ参加失敗に対応

### 🏗️ アーキテクチャ品質
- **分離性**: フロントエンド・バックエンド完全分離
- **スケーラビリティ**: Nakama分散対応、Docker化
- **保守性**: コンポーネント分離、サービス層分離
- **テスタビリティ**: モジュール化された構造

### 🔧 開発体験
- **セットアップ時間**: 5分以内（Docker利用）
- **ホットリロード**: フロントエンド対応
- **デバッグ環境**: 包括的なログとコンソール
- **ドキュメント**: README、CLAUDE.md、GAME_RULES.mdの3層構造

## 🎮 現在の使用方法

### 🚀 クイックスタート
1. **Docker環境を起動**:
   ```bash
   docker-compose up -d
   ```

2. **フロントエンド開発サーバーを起動**:
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

3. **ブラウザでアクセス**: http://localhost:3000

### 🎯 ゲームプレイ手順

#### **ログインと認証**
1. ユーザー名とパスワード（6文字以上）を入力
2. 新規登録または既存アカウントでログイン

#### **マッチの作成・参加**
1. **プライベートマッチ作成**: 「プライベートマッチ作成」ボタンをクリック
2. **マッチID共有**: 生成されたIDを他のプレイヤーに共有
3. **マッチ参加**: マッチIDを入力して「マッチに参加」をクリック

#### **ゲームプレイ（デモモード）**
1. **ゲーム開始**: 「🎮 ゲーム開始（デモモード）」ボタンをクリック
2. **コマ選択**: 
   - 青くハイライトされた現在のターンのコマをクリック
   - 移動可能位置が表示される:
     - **青い点（•）**: 通常移動
     - **オレンジの点（•）+ 黄色点線**: ジャンプ移動
3. **移動実行**: 移動したい位置をクリック
4. **ターン切り替え**: 自動的に相手のターンに切り替わり
5. **勝利**: 相手側の端ライン（白→黒のゴール、黒→白のゴール）に到達すると勝利

#### **ゲーム機能**
- **チャット**: 右側のチャットエリアでリアルタイム会話
- **ゲーム状態確認**: 現在のターン、プレイヤー情報、残り壁数を表示
- **ゲーム再開**: 勝利後、「新しいゲームを開始」ボタンで再戦可能

### 🐛 デバッグ機能
- **ブラウザコンソール（F12）**: 詳細なゲームログを確認
- **Nakamaコンソール**: http://localhost:7351 (admin/password)
- **移動計算ログ**: コマ選択時の移動可能位置計算過程を表示

## 📊 プロジェクト品質指標（2024年7月30日現在）

### 📈 コード品質
- **総行数**: 約1,500行（コメント・スタイル含む）
- **日本語コメント率**: 100%（全ファイル完全対応）
- **TypeScript導入率**: 100%（フロントエンド完全型安全）
- **エラーハンドリング**: WebSocket切断、認証失敗、ゲーム状態エラーに完全対応

### 🏗️ アーキテクチャ品質
- **分離性**: フロントエンド・バックエンド完全分離
- **スケーラビリティ**: Nakama分散対応、Docker化
- **保守性**: コンポーネント分離、純粋関数設計
- **テスタビリティ**: モジュール化された構造、詳細ログ出力

### 🎮 ゲーム完成度
- **基本移動システム**: 30%完成（移動・ジャンプのみ）
- **Quoridorルール**: 20%完成（壁配置機能が未実装）
- **マルチプレイヤー**: 0%完成（デモモードのみ）
- **UI/UX**: 60%完成（壁配置UIが未実装）
- **戦略性**: 10%完成（壁がないため単純すぎる）

### 🔧 開発体験
- **セットアップ時間**: 3分以内（Docker + npm）
- **ホットリロード**: フロントエンド完全対応
- **デバッグ環境**: 複数レベルのログ出力
- **ドキュメント**: 3層構造（README/CLAUDE/RULES）の完全ドキュメント

### 🚀 次期開発準備度
- **壁配置機能**: データ構造は定義済み、UI設計・実装が必要
- **マルチプレイヤー**: WebSocket基盤はあるが、同期ロジックが不完全
- **完全なQuoridorルール**: 経路探索アルゴリズムなど複雑な実装が必要

## 📝 開発履歴
- **2024年7月30日**: フェーズ2部分完了 - 基本移動システムのみ実装
- **基本移動システム**: 隣接移動・ジャンプ移動・斜めジャンプ実装
- **勝利システム**: シンプルな勝利判定・ゲーム終了・再開機能
- **UI/UX**: 視覚的移動表示・ターン制御・エラーハンドリング

## ⚠️ 現在の制限事項
- **Quoridorの核心機能である壁配置が未実装**
- **真のマルチプレイヤー対戦ができない（デモモードのみ）**
- **戦略性が低い（壁がないため移動だけの単純なゲーム）**
- **完全なゲーム体験には程遠い状態**